/*!
 * @license
 * EME Encryption Scheme Polyfill
 * Copyright 2019 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */

!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).EncryptionSchemePolyfills=e()}}((function(){var e={exports:{}};function i(e,i,t){return t?i?i(e):e:(e&&e.then||(e=Promise.resolve(e)),i?e.then(i):e)}function t(e,i,t){if(t)return i?i(e()):e();try{var n=Promise.resolve(e());return i?n.then(i):n}catch(o){return Promise.reject(o)}}function n(e,i){var t=e();return t&&t.then?t.then(i):i(t)}function o(){}class s{static install(){s.originalRMKSA_||navigator.requestMediaKeySystemAccess&&MediaKeySystemAccess.prototype.getConfiguration&&(s.originalRMKSA_=navigator.requestMediaKeySystemAccess,navigator.requestMediaKeySystemAccess=s.probeRMKSA_)}static probeRMKSA_(e,n){const o=this;return t((function(){return i(s.originalRMKSA_.call(o,e,n),(function(i){return l(i)?(navigator.requestMediaKeySystemAccess=s.originalRMKSA_,i):(navigator.requestMediaKeySystemAccess=s.polyfillRMKSA_,s.polyfillRMKSA_.call(o,e,n))}))}))}static polyfillRMKSA_(e,n){const o=this;return t((function(){const t=c(e),a=[];for(const e of n){const i=s.filterCapabilities_(e.videoCapabilities,t),n=s.filterCapabilities_(e.audioCapabilities,t);if(e.videoCapabilities&&e.videoCapabilities.length&&!i.length);else if(e.audioCapabilities&&e.audioCapabilities.length&&!n.length);else{const t=Object.assign({},e);t.videoCapabilities=i,t.audioCapabilities=n,a.push(t)}}if(!a.length){const e=new Error("Unsupported keySystem or supportedConfigurations.");throw e.name="NotSupportedError",e.code=DOMException.NOT_SUPPORTED_ERR,e}return i(s.originalRMKSA_.call(o,e,a),(function(e){return new r(e,t)}))}))}static filterCapabilities_(e,i){return e?e.filter(e=>!e.encryptionScheme||e.encryptionScheme==i):e}}class a{static install(){a.originalDecodingInfo_||navigator.mediaCapabilities&&(a.originalDecodingInfo_=navigator.mediaCapabilities.decodingInfo,navigator.mediaCapabilities.decodingInfo=a.probeDecodingInfo_)}static probeDecodingInfo_(e){const o=this;return t((function(){return i(a.originalDecodingInfo_.call(o,e),(function(t){let s=!1;if(!e.keySystemConfiguration)return t;const r=t.keySystemAccess;return r&&l(r)?(navigator.mediaCapabilities.decodingInfo=a.originalDecodingInfo_,t):(navigator.mediaCapabilities.decodingInfo=a.polyfillDecodingInfo_,n((function(){if(!r)return i(a.getMediaKeySystemAccess_(e),(function(e){return t.keySystemAccess=e,s=!0,t}))}),(function(i){return s?i:a.polyfillDecodingInfo_.call(o,e)})))}))}))}static polyfillDecodingInfo_(e){const s=this;return t((function(){let t=null;if(e.keySystemConfiguration){const n=e.keySystemConfiguration,o=n.keySystem,s=n.audio&&n.audio.encryptionScheme,a=n.video&&n.video.encryptionScheme;t=c(o);const r={powerEfficient:!1,smooth:!1,supported:!1,keySystemAccess:null,configuration:e};if(s&&s!=t)return i(r);if(a&&a!=t)return i(r)}return i(a.originalDecodingInfo_.call(s,e),(function(s){return n((function(){if(!s.keySystemAccess)return function(t){var n=function(){if(e.keySystemConfiguration)return i(a.getMediaKeySystemAccess_(e),(function(e){s.keySystemAccess=e}))}();if(n&&n.then)return n.then(o)}();s.keySystemAccess=new r(s.keySystemAccess,t)}),(function(){return s}))}))}))}static getMediaKeySystemAccess_(e){return t((function(){const t=a.convertToMediaKeySystemConfig_(e);return i(navigator.requestMediaKeySystemAccess(e.keySystemConfiguration.keySystem,[t]))}))}static convertToMediaKeySystemConfig_(e){const i=e.keySystemConfiguration,t=[],n=[];if(i.audio){const n={robustness:i.audio.robustness||"",contentType:e.audio.contentType};t.push(n)}if(i.video){const t={robustness:i.video.robustness||"",contentType:e.video.contentType};n.push(t)}const o={initDataTypes:i.initDataType?[i.initDataType]:[],distinctiveIdentifier:i.distinctiveIdentifier,persistentState:i.persistentState,sessionTypes:i.sessionTypes};return t.length&&(o.audioCapabilities=t),n.length&&(o.videoCapabilities=n),o}}class r{constructor(e,i){this.mksa_=e,this.scheme_=i,this.keySystem=e.keySystem}getConfiguration(){const e=this.mksa_.getConfiguration();if(e.videoCapabilities)for(const i of e.videoCapabilities)i.encryptionScheme=this.scheme_;if(e.audioCapabilities)for(const i of e.audioCapabilities)i.encryptionScheme=this.scheme_;return e}createMediaKeys(){return this.mksa_.createMediaKeys()}}function c(e){return e.startsWith("com.widevine")||e.startsWith("com.microsoft")||e.startsWith("com.adobe")||e.startsWith("org.w3")?"cenc":e.startsWith("com.apple")?"cbcs-1-9":(console.warn("EmeEncryptionSchemePolyfill: Unknown key system:",e,"Please contribute!"),null)}function l(e){const i=e.getConfiguration(),t=i.videoCapabilities&&i.videoCapabilities[0],n=i.audioCapabilities&&i.audioCapabilities[0],o=t||n;return!(!o||void 0===o.encryptionScheme)}s.originalRMKSA_,a.originalDecodingInfo_;return e.exports&&(e.exports=class{static install(){s.install(),a.install()}}),e=e.exports}));